{% extends "global/Page.html" %}
{% load staticfiles otree_tags %}

{% block styles %}
<link href="{% static "cultural_market/style.css" %}" rel="stylesheet">
{% endblock %}

{% block title %}
{% endblock %}

{% block content %}

<script type="text/javascript">
numArtifacts = {{ num_artifacts }};
var getViewHandler = function (artifact) {
    var viewed = false;
    return function () {
        $("#id_view_" + artifact).val('1');
        // Add 1 to visible count if not yet viewed
        if (!viewed) {
            var count = parseInt($("#view-count-" + artifact).text());
            $("#view-count-" + artifact).text(count + 1);
            viewed = true;
        }
        startTime = (new Date()).getTime();
    };
};
var getDownloadHandler = function (artifact) {
    var downloaded = false;
    return function () {
        $("#id_download_" + artifact).val('1');
        // Add 1 to visible count if not yet viewed
        if (!downloaded) {
            var count = parseInt($("#download-count-" + artifact).text());
            $("#download-count-" + artifact).text(count + 1);
            downloaded = true;
        }
    };
};
var getCloseHandler = function (artifact) {
    return function () {
        timeOnArtifact[artifact] += (new Date()).getTime() - startTime;
        $("#id_time_ms_" + artifact).val(timeOnArtifact[artifact])
    };
};
timeOnArtifact = []
var startTime;
$(document).ready(function () {
    for (var i = 0; i < numArtifacts; i++) {
        $(".play-media-" + i).click(getViewHandler(i));
        $("#media-player-" + i + " .close").click(getCloseHandler(i));
        $("#media-player-" + i + " .done").click(getCloseHandler(i));
        $(".download-" + i).click(getDownloadHandler(i));
        timeOnArtifact.push(0);
    }
});
</script>

<div id="market-image">
    
    <div class="debug">World {{ world }}</div>
    
    <input type="hidden" name="rows" id="id_rows" value="{{ num_rows }}"/>
    <input type="hidden" name="cols" id="id_cols" value="{{ num_columns }}"/>
    <input type="hidden" name="direction" id="id_direction" value="down,right"/>
    
    {% for artifact_row in artifacts_by_row %}
        {% for a in artifact_row %}
            {% include 'cultural_market/ImagePlayer.html' with artifact=a config=config %}
        {% endfor %}
    {% endfor %}
    
    <table class="table">
        <thead>
            <tr>
                {% for column_id in column_ids %}
                <th>
                    <span class="rank"cal
                        {% if world == 0 %} style="visibility:hidden;" {% endif %}
                    >
                        &nbsp;<br/>#
                    </span>
                    <span class="artifact-label"></span>
                    <div class="stats">
                        <span class="view">
                            {% if config.show_views and world != 0 %}
                            Views
                            {% endif %}
                        </span>
                        <span class="rating">
                            {% if config.show_ratings and world != 0 %}
                            Rating
                            {% endif %}
                        </span>
                        <span class="download">
                            {% if config.show_downloads and world != 0 %}
                            Down-<br/>loads
                            {% endif %}
                        </span>
                    </div>
                </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for artifact_row in artifacts_by_row %}
            <tr>
                {% for a in artifact_row %}
                    {% include "cultural_market/Image.html" with artifact=a config=config width=width%}
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
</div>

    {% next_button %}

{% endblock %}
